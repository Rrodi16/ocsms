{% extends 'base.html' %}
{% block title %}Make Payment - OCSMS{% endblock %}
{% block content %}
<div class="container py-4">
    <h2 class="mb-4"><i class="fas fa-credit-card"></i> Make Payment</h2>
    
    <!-- Balance Information -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-wallet"></i> Available Balance
                    </h5>
                    <p class="display-4 font-weight-bold">ETB {{ virtual_balance|floatformat:2 }}</p>
                    <p class="mb-0">
                        <i class="fas fa-info-circle"></i> 
                    </p>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card bg-light">
                <div class="card-body">
                    <h5 class="card-title text-dark">
                        <i class="fas fa-bolt"></i> Quick Payment Info
                    </h5>
                    <ul class="list-unstyled mb-0">
                        <li class="mb-2">
                            <i class="fas fa-check text-success"></i>
                            <strong>Instant processing</strong>
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-success"></i>
                            <strong>Automatic receipt generation</strong>
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-success"></i>
                            <strong>Real-time balance updates</strong>
                        </li>
                        <li>
                            <i class="fas fa-check text-success"></i>
                            <strong>Full payment history</strong>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <!-- Left Column: Payment Form -->
        <div class="col-md-6">
            <div class="card shadow">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-money-check-alt"></i> Payment Details
                    </h5>
                </div>
                <div class="card-body">
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} py-2">{{ message }}</div>
                        {% endfor %}
                    {% endif %}
                    
                    <!-- Payment Form -->
                    <form method="POST">
                        {% csrf_token %}
                        
                        <!-- Hidden agreement field -->
                        <input type="hidden" name="agreement" value="{{ active_agreement.id }}">
                        
                        <!-- Payment Amount Section -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="fas fa-money-bill-wave"></i> Payment Amount (ETB)
                            </label>
                            
                            <!-- Quick Amount Buttons -->
                            <div class="row g-2 mb-3">
                                <div class="col-6">
                                    <button type="button" 
                                            class="btn btn-outline-primary w-100 py-3 quick-amount-btn"
                                            data-amount="500">
                                        <div class="fs-5 fw-bold">ETB 500</div>
                                    </button>
                                </div>
                                <div class="col-6">
                                    <button type="button" 
                                            class="btn btn-outline-success w-100 py-3 quick-amount-btn"
                                            data-amount="1000">
                                        <div class="fs-5 fw-bold">ETB 1,000</div>
                                    </button>
                                </div>
                                <div class="col-6">
                                    <button type="button" 
                                            class="btn btn-outline-info w-100 py-3 quick-amount-btn"
                                            data-amount="5000">
                                        <div class="fs-5 fw-bold">ETB 5,000</div>
                                    </button>
                                </div>
                                <div class="col-6">
                                    <button type="button" 
                                            class="btn btn-outline-warning w-100 py-3 quick-amount-btn"
                                            data-amount="10000">
                                        <div class="fs-5 fw-bold">ETB 10,000</div>
                                    </button>
                                </div>
                                {% if remaining_balance > 500 %}
                                <div class="col-12 mt-2">
                                    <button type="button" 
                                            class="btn btn-outline-danger w-100 py-3 quick-amount-btn"
                                            data-amount="{{ remaining_balance|floatformat:2 }}">
                                        <div class="fs-5 fw-bold">ETB {{ remaining_balance|floatformat:2 }}</div>
                                    </button>
                                </div>
                                {% endif %}
                            </div>
                            
                            <!-- Amount Input -->
                            <div class="input-group input-group-lg">
                                <span class="input-group-text bg-light">ETB</span>
                                <input type="number" 
                                       id="amount_paid" 
                                       name="amount_paid" 
                                       class="form-control" 
                                       step="100"
                                       min="500"
                                       max="{{ virtual_balance }}"
                                       placeholder="Enter amount"
                                       value="500"
                                       required>
                            </div>
                            <div class="form-text">
                                Minimum payment: ETB 500.00 | Maximum: ETB {{ virtual_balance|floatformat:2 }}
                            </div>
                        </div>
                        
                        <!-- Payment Description -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="fas fa-sticky-note"></i> Payment Description
                            </label>
                            <input type="text" 
                                   name="description" 
                                   class="form-control" 
                                   placeholder="e.g., Tuition fee payment for 2025-2026"
                                   value="Payment for Agreement #{{ active_agreement.id }}">
                            <div class="form-text">
                                Optional description for your records.
                            </div>
                        </div>
                        
                        <!-- Terms Agreement -->
                        <div class="mb-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="terms" required>
                                <label class="form-check-label" for="terms">
                                    I confirm that I authorize this payment from my allocated balance.
                                </label>
                            </div>
                        </div>
                        
                        <!-- Submit Button -->
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-paper-plane"></i> Process Payment of 
                                <span id="display_amount">ETB 500.00</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Right Column: Summary -->
        <div class="col-md-6">
            <!-- All Agreements Summary -->
            <div class="card shadow mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar"></i> All Agreements Summary
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Statistics -->
                    <div class="row text-center mb-3">
                        <div class="col-4">
                            <div class="mb-2">
                                <small class="text-muted">Agreements</small>
                                <div class="fw-bold text-primary">{{ all_agreements_count }}</div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="mb-2">
                                <small class="text-muted">Active</small>
                                <div class="fw-bold text-success">{{ active_agreements.count }}</div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="mb-2">
                                <small class="text-muted">Payments</small>
                                <div class="fw-bold text-warning">{{ total_payments_count }}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Financial Summary -->
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <tr class="table-light">
                                <td><strong>Total Cost:</strong></td>
                                <td class="text-end fw-bold fs-5">ETB {{ total_summary.all_cost|floatformat:2 }}</td>
                            </tr>
                            <tr class="table-light">
                                <td><strong>Total Paid:</strong></td>
                                <td class="text-end text-success fs-5">ETB {{ total_summary.all_paid|floatformat:2 }}</td>
                            </tr>
                            <tr class="table-light">
                                <td><strong>Remaining Balance:</strong></td>
                                <td class="text-end text-danger fw-bold fs-5">ETB {{ total_summary.all_remaining|floatformat:2 }}</td>
                            </tr>
                        </table>
                    </div>
                    
                    <!-- Overall Progress Bar -->
                    {% if total_summary.all_cost > 0 %}
                    <div class="mt-3">
                        <small class="text-muted">Overall Payment Progress</small>
                        <div class="progress" style="height: 12px;">
                            {% widthratio total_summary.all_paid total_summary.all_cost 100 as overall_progress %}
                            <div class="progress-bar bg-info" 
                                 role="progressbar" 
                                 style="width: {{ overall_progress }}%;"
                                 aria-valuenow="{{ overall_progress }}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                            </div>
                        </div>
                        <div class="text-center">
                            <small class="text-muted">
                                {{ overall_progress }}% Complete
                            </small>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Current Agreement Details -->
            {% if active_agreement %}
            <div class="card shadow mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-file-contract"></i> Current Agreement Details
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <tr>
                                <td><strong>Agreement ID:</strong></td>
                                <td class="text-end">#{{ active_agreement.id }}</td>
                            </tr>
                            <tr>
                                <td><strong>Academic Year:</strong></td>
                                <td class="text-end">{{ active_agreement.academic_year }}</td>
                            </tr>
                            <tr>
                                <td><strong>Total Cost:</strong></td>
                                <td class="text-end fw-bold">ETB {{ active_agreement.total_cost|floatformat:2 }}</td>
                            </tr>
                            <tr>
                                <td><strong>Amount Paid:</strong></td>
                                <td class="text-end text-success">ETB {{ active_agreement.amount_paid|default:0|floatformat:2 }}</td>
                            </tr>
                            <tr>
                                <td><strong>Remaining:</strong></td>
                                <td class="text-end text-danger fw-bold">ETB {{ remaining_balance|floatformat:2 }}</td>
                            </tr>
                        </table>
                    </div>
                    
                    <!-- Progress Bar for Current Agreement -->
                    {% if active_agreement.total_cost > 0 %}
                    <div class="mt-3">
                        <small class="text-muted">Payment Progress</small>
                        <div class="progress" style="height: 12px;">
                            {% widthratio active_agreement.amount_paid|default:0 active_agreement.total_cost 100 as agreement_progress %}
                            <div class="progress-bar bg-success" 
                                 role="progressbar" 
                                 style="width: {{ agreement_progress }}%;"
                                 aria-valuenow="{{ agreement_progress }}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                            </div>
                        </div>
                        <div class="text-center">
                            <small class="text-muted">
                                {{ agreement_progress }}% Complete
                            </small>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
            
            <!-- Payment Confirmation -->
            <div class="card shadow">
                <div class="card-header bg-warning">
                    <h5 class="mb-0">
                        <i class="fas fa-shield-alt"></i> Secure Payment Confirmation
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-light border">
                        <h6><i class="fas fa-lock text-success"></i> Secure Processing</h6>
                        <p class="mb-2">
                            Your payment will be processed immediately and a receipt will be generated automatically.
                        </p>
                        
                        <h6><i class="fas fa-receipt text-primary"></i> Receipt & Records</h6>
                        <p class="mb-2">
                            After payment, you can download your receipt from the payment history page.
                        </p>
                        
                        <h6><i class="fas fa-history text-info"></i> Transaction History</h6>
                        <p class="mb-0">
                            All payments are recorded in your transaction history for future reference.
                        </p>
                    </div>
                    
                    <div class="text-center">
                        <a href="{% url 'payment_history' %}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-history"></i> View Payment History
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    const amountInput = document.getElementById('amount_paid');
    const displayAmount = document.getElementById('display_amount');
    const quickAmountButtons = document.querySelectorAll('.quick-amount-btn');
    const termsCheckbox = document.getElementById('terms');
    
    // Function to format currency
    function formatCurrency(amount) {
        return 'ETB ' + parseFloat(amount).toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }
    
    // Update displayed amount when input changes
    amountInput.addEventListener('input', function() {
        const amount = parseFloat(this.value) || 0;
        displayAmount.textContent = formatCurrency(amount);
    });
    
    // Quick amount button click handlers
    quickAmountButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const amount = parseFloat(this.dataset.amount);
            amountInput.value = amount;
            displayAmount.textContent = formatCurrency(amount);
            
            // Highlight the selected button
            quickAmountButtons.forEach(btn => {
                if (parseFloat(btn.dataset.amount) === amount) {
                    btn.classList.add('btn-primary', 'text-white');
                    btn.classList.remove('btn-outline-primary', 'btn-outline-success', 'btn-outline-info', 'btn-outline-warning', 'btn-outline-danger');
                } else {
                    btn.classList.remove('btn-primary', 'text-white');
                    const btnAmount = parseFloat(btn.dataset.amount);
                    if (btnAmount === 500) {
                        btn.classList.add('btn-outline-primary');
                    } else if (btnAmount === 1000) {
                        btn.classList.add('btn-outline-success');
                    } else if (btnAmount === 5000) {
                        btn.classList.add('btn-outline-info');
                    } else if (btnAmount === 10000) {
                        btn.classList.add('btn-outline-warning');
                    } else if (btnAmount === {{ remaining_balance|floatformat:2 }}) {
                        btn.classList.add('btn-outline-danger');
                    }
                }
            });
        });
    });
    
    // Form validation
    form.addEventListener('submit', function(e) {
        const amount = parseFloat(amountInput.value) || 0;
        const virtualBalance = {{ virtual_balance }};
        const remainingBalance = {{ remaining_balance }};
        
        // Check terms agreement
        if (!termsCheckbox.checked) {
            e.preventDefault();
            alert('Please confirm the terms by checking the agreement box.');
            termsCheckbox.focus();
            return false;
        }
        
        // Check minimum amount
        if (amount < 500) {
            e.preventDefault();
            alert('Minimum payment amount is ETB 500.00');
            amountInput.value = '500';
            amountInput.focus();
            return false;
        }
        
        // Check against virtual balance
        if (amount > virtualBalance) {
            e.preventDefault();
            alert(`Amount cannot exceed your available balance of ${formatCurrency(virtualBalance)}`);
            amountInput.value = virtualBalance.toFixed(2);
            amountInput.focus();
            return false;
        }
        
        // Check against remaining agreement balance
        if (amount > remainingBalance) {
            e.preventDefault();
            alert(`Amount exceeds remaining agreement balance of ${formatCurrency(remainingBalance)}`);
            amountInput.value = Math.min(remainingBalance, virtualBalance).toFixed(2);
            amountInput.focus();
            return false;
        }
        
        // Show loading
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        submitBtn.disabled = true;
        
        // Re-enable after 5 seconds if still on page (safety net)
        setTimeout(() => {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        }, 5000);
        
        return true;
    });
    
    // Initialize display
    displayAmount.textContent = formatCurrency(amountInput.value);
});
</script>

<style>
.card {
    border: none;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    transition: transform 0.2s;
}
.card:hover {
    transform: translateY(-2px);
}
.quick-amount-btn {
    height: 100%;
    transition: all 0.2s;
    border-width: 2px;
    border-radius: 8px;
}
.quick-amount-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
.quick-amount-btn.btn-primary {
    border-color: #0d6efd;
}
.progress {
    border-radius: 20px;
    overflow: hidden;
}
.form-check-input:checked {
    background-color: #198754;
    border-color: #198754;
}
.table td {
    padding: 0.75rem 0.5rem;
}
.badge {
    font-size: 0.8em;
    padding: 0.4em 0.8em;
}
</style>
{% endblock %}