{% extends 'base.html' %}

{% block title %}Registrar Officer Dashboard - OCSMS{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-tachometer-alt me-2"></i>Registrar Dashboard
        </h1>
        <div>
            <a href="{% url 'upload_student_data' %}" class="btn btn-primary">
                <i class="fas fa-upload me-1"></i> Upload Students
            </a>
        </div>
    </div>

    <!-- Main Statistics Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Total Students</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ students_uploaded }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-users fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                With Agreements</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ students_with_agreements }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-file-contract fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Without Agreements</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ students_without_agreements_count }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-exclamation-triangle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Compliance Rate</div>
                            <div class="row no-gutters align-items-center">
                                <div class="col-auto">
                                    <div class="h5 mb-0 mr-3 font-weight-bold text-gray-800">{{ compliance_rate|floatformat:1 }}%</div>
                                </div>
                                <div class="col">
                                    <div class="progress progress-sm mr-2">
                                        <div class="progress-bar bg-info" role="progressbar"
                                            style="width: {{ compliance_rate }}%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-chart-pie fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Student Management Cards -->
    <div class="row">
        <!-- All Students Management Card -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow border-primary h-100">
                <div class="card-header bg-primary text-white">
                    <h6 class="m-0 font-weight-bold">
                        <i class="fas fa-users me-2"></i>All Students
                    </h6>
                </div>
                <div class="card-body text-center">
                    <div class="h1 text-primary mb-3">{{ students_uploaded }}</div>
                    <p class="card-text">Total students in the system</p>
                    <div class="d-grid gap-2">
                        <a href="#all-students-section" class="btn btn-primary">
                            <i class="fas fa-list me-1"></i> Manage Students
                        </a>
                        <a href="{% url 'download_student_data' %}" class="btn btn-outline-primary">
                            <i class="fas fa-download me-1"></i> Export Data
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Required Card -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow border-warning h-100">
                <div class="card-header bg-warning text-white">
                    <h6 class="m-0 font-weight-bold">
                        <i class="fas fa-exclamation-triangle me-2"></i>Action Required
                    </h6>
                </div>
                <div class="card-body text-center">
                    <div class="h1 text-warning mb-3">{{ students_without_agreements_count }}</div>
                    <p class="card-text">Students without cost sharing agreements</p>
                    <div class="alert alert-warning small">
                        <i class="fas fa-bell me-1"></i>
                        Send reminders to complete agreements
                    </div>
                    <div class="d-grid gap-2">
                        <a href="{% url 'students_without_agreements' %}" class="btn btn-warning">
                            <i class="fas fa-eye me-1"></i> View Details
                        </a>
                        <a href="{% url 'send_reminder_notifications' %}" class="btn btn-outline-warning">
                            <i class="fas fa-paper-plane me-1"></i> Send Reminders
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cost Officer Assignment Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-info text-white">
                    <h6 class="m-0 font-weight-bold">
                        <i class="fas fa-user-tie me-2"></i>Assign Students to Cost Sharing Officers
                    </h6>
                </div>
                <div class="card-body">
                    <form id="assignStudentsForm" method="post" action="{% url 'upload_students_to_cost_officer' %}">
                        {% csrf_token %}
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="cost_officer_id" class="form-label">Select Cost Sharing Officer:</label>
                                    <select class="form-control" id="cost_officer_id" name="cost_officer_id" required>
                                        <option value="">-- Select Officer --</option>
                                        {% for officer in cost_officers %}
                                        <option value="{{ officer.id }}">
                                            {{ officer.get_full_name|default:officer.username }} - {{ officer.email }}
                                        </option>
                                        {% empty %}
                                        <option value="">No cost sharing officers available</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="form-label">Options:</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="only_without_agreements" name="only_without_agreements" checked>
                                        <label class="form-check-label" for="only_without_agreements">
                                            Only students without agreements
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="send_notification" name="send_notification" checked>
                                        <label class="form-check-label" for="send_notification">
                                            Send notification to officer
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="form-label">Actions:</label>
                                    <div class="d-grid gap-2">
                                        <button type="button" class="btn btn-info" onclick="selectAllStudents()">
                                            <i class="fas fa-check-square me-1"></i> Select All Visible
                                        </button>
                                        <button type="button" class="btn btn-outline-info" onclick="deselectAllStudents()">
                                            <i class="fas fa-times-circle me-1"></i> Deselect All
                                        </button>
                                        <button type="button" class="btn btn-warning" onclick="debugSelection()">
                                            <i class="fas fa-bug me-1"></i> Debug Selection
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button type="submit" class="btn btn-success" id="assignButton" disabled>
                                <i class="fas fa-user-plus me-1"></i> Assign Selected Students
                            </button>
                            <span id="selectedCount" class="ms-2 text-muted">0 students selected</span>
                            <div id="debugInfo" class="mt-2 small text-muted" style="display: none;"></div>
                        </div>
                        
                        <!-- HIDDEN FIELD CONTAINER FOR STUDENT IDs -->
                        <div id="studentIdsContainer" style="display: none;">
                            <!-- Student IDs will be added here dynamically -->
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- All Students Management Section -->
    <div class="row" id="all-students-section">
        <div class="col-12">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-list me-2"></i>Student Management
                    </h6>
                    <div class="d-flex gap-2">
                        <!-- Department Filter -->
                        <form method="get" class="d-flex">
                            <select class="form-control form-control-sm" name="department" onchange="this.form.submit()">
                                <option value="">All Departments</option>
                                {% for dept in departments %}
                                <option value="{{ dept }}" {% if selected_department == dept %}selected{% endif %}>
                                    {{ dept }}
                                </option>
                                {% endfor %}
                            </select>
                        </form>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover" width="100%" cellspacing="0" style="font-size: 14px; font-weight: 500;">
                            <thead class="thead-light">
                                <tr>
                                    <th width="30" style="background-color: #f8f9fa; font-weight: 700; color: #2c3e50; padding: 12px 8px;">
                                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)" style="transform: scale(1.3);">
                                    </th>
                                    <th style="background-color: #f8f9fa; font-weight: 700; color: #2c3e50; padding: 12px 8px;">Student ID</th>
                                    <th style="background-color: #f8f9fa; font-weight: 700; color: #2c3e50; padding: 12px 8px;">Full Name</th>
                                    <th style="background-color: #f8f9fa; font-weight: 700; color: #2c3e50; padding: 12px 8px;">Department</th>
                                    <th style="background-color: #f8f9fa; font-weight: 700; color: #2c3e50; padding: 12px 8px;">Year of Study</th>
                                    <th style="background-color: #f8f9fa; font-weight: 700; color: #2c3e50; padding: 12px 8px;">Academic Year</th>
                                    <th style="background-color: #f8f9fa; font-weight: 700; color: #2c3e50; padding: 12px 8px;">Agreement Status</th>
                                    <th style="background-color: #f8f9fa; font-weight: 700; color: #2c3e50; padding: 12px 8px;">Assigned To</th>
                                    <th style="background-color: #f8f9fa; font-weight: 700; color: #2c3e50; padding: 12px 8px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for student in all_students %}
                                <tr style="font-size: 13px;">
                                    <td style="padding: 10px 8px;">
                                        <input type="checkbox" class="student-checkbox" name="student_ids" value="{{ student.id }}" 
                                               onchange="updateSelectedCount()" style="transform: scale(1.3);">
                                    </td>
                                    <td style="font-weight: 600; color: #2c3e50; padding: 10px 8px;"><strong>{{ student.student_id }}</strong></td>
                                    <td style="color: #2c3e50; padding: 10px 8px;">{{ student.full_name }}</td>
                                    <td style="color: #2c3e50; padding: 10px 8px;">{{ student.department }}</td>
                                    <td style="padding: 10px 8px;">
                                        {% if student.user.year_of_study %}
                                            <span class="badge badge-primary" style="font-size: 12px; padding: 8px 12px; font-weight: 700; color: white !important; background-color: #4e73df !important;">Year {{ student.user.year_of_study }}</span>
                                        {% else %}
                                            <span class="badge badge-secondary" style="font-size: 12px; padding: 8px 12px; font-weight: 700; color: white !important; background-color: #6c757d !important;">Not set</span>
                                        {% endif %}
                                    </td>
                                    <td style="color: #2c3e50; padding: 10px 8px;">{{ student.academic_year }}</td>
                                    <td style="padding: 10px 8px;">
                                        {% if student.student_id in students_with_agreements_ids %}
                                            <span class="badge badge-success" style="font-size: 12px; padding: 8px 12px; font-weight: 700; color: white !important; background-color: #1cc88a !important;">Has Agreement</span>
                                        {% else %}
                                            <span class="badge badge-warning" style="font-size: 12px; padding: 8px 12px; font-weight: 700; color: white !important; background-color: #f6c23e !important;">No Agreement</span>
                                        {% endif %}
                                    </td>
                                    <td style="padding: 10px 8px;">
                                        {% if student.assigned_to %}
                                            <span class="badge badge-info" style="font-size: 12px; padding: 8px 12px; font-weight: 700; color: white !important; background-color: #36b9cc !important;">
                                                {{ student.assigned_to.get_full_name|default:student.assigned_to.username }}
                                            </span>
                                        {% else %}
                                            <span class="badge badge-secondary" style="font-size: 12px; padding: 8px 12px; font-weight: 700; color: white !important; background-color: #6c757d !important;">Not assigned</span>
                                        {% endif %}
                                    </td>
                                    <td style="padding: 10px 8px;">
                                        <div class="btn-group btn-group-sm">
                                            <a href="{% url 'edit_student' student.student_id %}" class="btn btn-warning" title="Edit Student" style="font-size: 11px; padding: 6px 10px; font-weight: 600;">
                                                <i class="fas fa-edit"></i> Edit
                                            </a>
                                            <button type="button" class="btn btn-info assign-single-btn" 
                                                    data-student-id="{{ student.id }}"
                                                    data-student-name="{{ student.full_name }}"
                                                    title="Assign to Cost Officer"
                                                    style="font-size: 11px; padding: 6px 10px; font-weight: 600;">
                                                <i class="fas fa-user-tie"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="9" class="text-center py-4">
                                        <i class="fas fa-users fa-3x text-muted mb-3"></i>
                                        <p class="text-muted">No students found</p>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    {% if all_students.has_other_pages %}
                    <nav aria-label="Page navigation" class="mt-4">
                        <ul class="pagination justify-content-center">
                            {% if all_students.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ all_students.previous_page_number }}{% if selected_department %}&department={{ selected_department }}{% endif %}#all-students-section">
                                    <i class="fas fa-chevron-left"></i> Previous
                                </a>
                            </li>
                            {% endif %}

                            {% for i in all_students.paginator.page_range %}
                            {% if all_students.number == i %}
                            <li class="page-item active">
                                <span class="page-link">{{ i }}</span>
                            </li>
                            {% else %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ i }}{% if selected_department %}&department={{ selected_department }}{% endif %}#all-students-section">
                                    {{ i }}
                                </a>
                            </li>
                            {% endif %}
                            {% endfor %}

                            {% if all_students.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ all_students.next_page_number }}{% if selected_department %}&department={{ selected_department }}{% endif %}#all-students-section">
                                    Next <i class="fas fa-chevron-right"></i>
                                </a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Single Assignment Modal -->
<div class="modal fade" id="singleAssignmentModal" tabindex="-1" aria-labelledby="singleAssignmentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="singleAssignmentModalLabel">
                    <i class="fas fa-user-tie me-2"></i>Assign Student to Cost Officer
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="singleAssignForm" method="post" action="{% url 'upload_students_to_cost_officer' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <input type="hidden" id="single_student_id" name="student_ids">
                    <div class="mb-3">
                        <label for="single_student_name" class="form-label">Student:</label>
                        <input type="text" class="form-control" id="single_student_name" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="single_cost_officer_id" class="form-label">Cost Sharing Officer:</label>
                        <select class="form-control" id="single_cost_officer_id" name="cost_officer_id" required>
                            <option value="">-- Select Officer --</option>
                            {% for officer in cost_officers %}
                            <option value="{{ officer.id }}">
                                {{ officer.get_full_name|default:officer.username }} - {{ officer.email }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="single_send_notification" name="send_notification" checked>
                        <label class="form-check-label" for="single_send_notification">
                            Send notification to officer
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Assign Student</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.card {
    border: none;
    border-radius: 10px;
    transition: transform 0.2s ease-in-out;
}
.card:hover {
    transform: translateY(-2px);
}
.card-header {
    border-radius: 10px 10px 0 0 !important;
    border: none;
}
.btn-block {
    border-radius: 8px;
}
.badge {
    font-size: 0.75em;
}
.table th {
    border-top: none;
    font-weight: 600;
    background-color: #f8f9fa;
}
.student-checkbox {
    transform: scale(1.2);
}
.assign-single-btn {
    padding: 0.25rem 0.5rem;
}

/* Enhanced badge visibility */
.badge-primary {
    background-color: #4e73df !important;
    color: white !important;
}
.badge-success {
    background-color: #1cc88a !important;
    color: white !important;
}
.badge-warning {
    background-color: #f6c23e !important;
    color: white !important;
}
.badge-info {
    background-color: #36b9cc !important;
    color: white !important;
}
.badge-secondary {
    background-color: #6c757d !important;
    color: white !important;
}
</style>

<script>
// Student selection management
function updateSelectedCount() {
    const checkboxes = document.querySelectorAll('.student-checkbox:checked');
    const count = checkboxes.length;
    document.getElementById('selectedCount').textContent = count + ' students selected';
    document.getElementById('assignButton').disabled = count === 0;
    
    // Update hidden fields for form submission
    updateStudentIds();
}

function updateStudentIds() {
    const container = document.getElementById('studentIdsContainer');
    container.innerHTML = ''; // Clear existing
    
    const checkboxes = document.querySelectorAll('.student-checkbox:checked');
    checkboxes.forEach(checkbox => {
        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.name = 'student_ids';
        hiddenInput.value = checkbox.value;
        container.appendChild(hiddenInput);
    });
    
    console.log('ðŸŽ¯ Updated student IDs:', Array.from(checkboxes).map(cb => cb.value));
}

function toggleSelectAll(source) {
    const checkboxes = document.querySelectorAll('.student-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = source.checked;
    });
    updateSelectedCount();
}

function selectAllStudents() {
    const checkboxes = document.querySelectorAll('.student-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = true;
    });
    document.getElementById('selectAll').checked = true;
    updateSelectedCount();
}

function deselectAllStudents() {
    const checkboxes = document.querySelectorAll('.student-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
    document.getElementById('selectAll').checked = false;
    updateSelectedCount();
}

// Debug function to check what's being submitted
function debugSelection() {
    const checkboxes = document.querySelectorAll('.student-checkbox:checked');
    const studentIds = Array.from(checkboxes).map(cb => cb.value);
    
    const debugInfo = document.getElementById('debugInfo');
    debugInfo.innerHTML = `
        <strong>Debug Info:</strong><br>
        - Checked checkboxes: ${checkboxes.length}<br>
        - Student IDs: ${studentIds.join(', ')}<br>
        - Cost Officer: ${document.getElementById('cost_officer_id').value}<br>
        - Form will submit ${studentIds.length} student IDs
    `;
    debugInfo.style.display = 'block';
    
    console.log('ðŸŽ¯ DEBUG - Checked checkboxes:', checkboxes.length);
    console.log('ðŸŽ¯ DEBUG - Student IDs:', studentIds);
    console.log('ðŸŽ¯ DEBUG - Cost Officer:', document.getElementById('cost_officer_id').value);
}

// Single student assignment
document.addEventListener('DOMContentLoaded', function() {
    const assignButtons = document.querySelectorAll('.assign-single-btn');
    const modal = new bootstrap.Modal(document.getElementById('singleAssignmentModal'));
    
    assignButtons.forEach(button => {
        button.addEventListener('click', function() {
            const studentId = this.getAttribute('data-student-id');
            const studentName = this.getAttribute('data-student-name');
            
            document.getElementById('single_student_id').value = studentId;
            document.getElementById('single_student_name').value = studentName;
            
            modal.show();
        });
    });

    // Smooth scroll to students section
    const links = document.querySelectorAll('a[href^="#"]');
    links.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });

    // Form validation for bulk assignment
    const assignForm = document.getElementById('assignStudentsForm');
    assignForm.addEventListener('submit', function(e) {
        const officerSelect = document.getElementById('cost_officer_id');
        const checkboxes = document.querySelectorAll('.student-checkbox:checked');
        
        console.log('ðŸŽ¯ FORM SUBMISSION DEBUG:');
        console.log('ðŸŽ¯ Officer ID:', officerSelect.value);
        console.log('ðŸŽ¯ Student IDs to submit:', Array.from(checkboxes).map(cb => cb.value));
        console.log('ðŸŽ¯ Checkbox count:', checkboxes.length);
        
        // Ensure student IDs are updated before submission
        updateStudentIds();
        
        if (!officerSelect.value) {
            e.preventDefault();
            alert('Please select a cost sharing officer.');
            officerSelect.focus();
            return false;
        }
        
        if (checkboxes.length === 0) {
            e.preventDefault();
            alert('Please select at least one student.');
            return false;
        }
        
        // Show loading state
        const assignButton = document.getElementById('assignButton');
        assignButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Assigning...';
        assignButton.disabled = true;
        
        // Log final data being submitted
        const formData = new FormData(this);
        console.log('ðŸŽ¯ FINAL FORM DATA:');
        for (let [key, value] of formData.entries()) {
            console.log(`  ${key}: ${value}`);
        }
    });

    // Initialize student IDs on page load
    updateStudentIds();
});

// Filter students without agreements
function filterWithoutAgreements() {
    const onlyWithout = document.getElementById('only_without_agreements').checked;
    const rows = document.querySelectorAll('tbody tr');
    
    rows.forEach(row => {
        const agreementBadge = row.querySelector('.badge-warning');
        if (onlyWithout && agreementBadge) {
            row.style.display = '';
        } else if (onlyWithout && !agreementBadge) {
            row.style.display = 'none';
        } else {
            row.style.display = '';
        }
    });
}
</script>
{% endblock %}