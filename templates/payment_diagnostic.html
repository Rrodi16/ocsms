<!DOCTYPE html>
<html>
<head>
    <title>Payment System Diagnostic</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .card { margin-bottom: 20px; }
        .stat-card { text-align: center; padding: 20px; }
        .stat-number { font-size: 2rem; font-weight: bold; }
        .stat-label { font-size: 0.9rem; color: #666; }
        .healthy { color: #28a745; }
        .warning { color: #ffc107; }
        .danger { color: #dc3545; }
        .info { color: #17a2b8; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">üí∞ Payment System Diagnostic</h1>
        
        <!-- System Health Overview -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">System Health Overview</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-number {% if bank_accounts_exist %}healthy{% else %}danger{% endif %}">
                                {{ bank_accounts_exist|yesno:"‚úÖ,‚ùå" }}
                            </div>
                            <div class="stat-label">Bank Accounts</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-number {% if cost_structures_exist %}healthy{% else %}warning{% endif %}">
                                {{ cost_structures_exist|yesno:"‚úÖ,‚ùå" }}
                            </div>
                            <div class="stat-label">Cost Structures</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-number {% if active_agreements_exist %}healthy{% else %}info{% endif %}">
                                {{ active_agreements_exist|yesno:"‚úÖ,‚ùå" }}
                            </div>
                            <div class="stat-label">Active Agreements</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-number {% if total_payments > 0 %}healthy{% else %}info{% endif %}">
                                {{ total_payments }}
                            </div>
                            <div class="stat-label">Total Payments</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payment Statistics -->
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Payment Statistics</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm">
                            <tr>
                                <td>Total Payments:</td>
                                <td class="text-end"><strong>{{ total_payments }}</strong></td>
                            </tr>
                            <tr>
                                <td>Pending:</td>
                                <td class="text-end"><span class="text-warning">{{ pending_payments }}</span></td>
                            </tr>
                            <tr>
                                <td>Completed:</td>
                                <td class="text-end"><span class="text-success">{{ completed_payments }}</span></td>
                            </tr>
                            <tr>
                                <td>Partial:</td>
                                <td class="text-end"><span class="text-info">{{ partial_payments }}</span></td>
                            </tr>
                            <tr>
                                <td>Failed:</td>
                                <td class="text-end"><span class="text-danger">{{ failed_payments }}</span></td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Amount Statistics</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm">
                            <tr>
                                <td>Total Amount:</td>
                                <td class="text-end"><strong>ETB {{ total_amount|floatformat:2 }}</strong></td>
                            </tr>
                            <tr>
                                <td>Pending Amount:</td>
                                <td class="text-end">ETB {{ pending_amount|floatformat:2 }}</td>
                            </tr>
                            <tr>
                                <td>Completed Amount:</td>
                                <td class="text-end">ETB {{ completed_amount|floatformat:2 }}</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Problem Detection -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Problem Detection</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="stat-card">
                            <div class="stat-number {% if payments_without_agreement_count == 0 %}healthy{% else %}danger{% endif %}">
                                {{ payments_without_agreement_count }}
                            </div>
                            <div class="stat-label">Payments without Agreement</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-card">
                            <div class="stat-number {% if payments_without_amount_count == 0 %}healthy{% else %}danger{% endif %}">
                                {{ payments_without_amount_count }}
                            </div>
                            <div class="stat-label">Payments without Amount</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-card">
                            <div class="stat-number {% if payments_without_date_count == 0 %}healthy{% else %}danger{% endif %}">
                                {{ payments_without_date_count }}
                            </div>
                            <div class="stat-label">Payments without Date</div>
                        </div>
                    </div>
                </div>
                
                {% if recent_problematic %}
                <div class="mt-3">
                    <h6>Recent Problematic Payments:</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Transaction Code</th>
                                    <th>Amount</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                    <th>Issues</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for payment in recent_problematic %}
                                <tr>
                                    <td>{{ payment.id }}</td>
                                    <td>{{ payment.transaction_code|default:"‚ùå Missing" }}</td>
                                    <td>{{ payment.amount_paid|default:"‚ùå Missing" }}</td>
                                    <td>{{ payment.date_paid|default:"‚ùå Missing" }}</td>
                                    <td>{{ payment.status }}</td>
                                    <td>
                                        {% if not payment.agreement %}‚ùå No Agreement{% endif %}
                                        {% if not payment.amount_paid %}‚ùå No Amount{% endif %}
                                        {% if not payment.date_paid %}‚ùå No Date{% endif %}
                                        {% if not payment.transaction_code %}‚ùå No Transaction Code{% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Payment Method Distribution -->
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Payment Methods</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Method</th>
                                        <th class="text-end">Count</th>
                                        <th class="text-end">Total Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for method in payment_methods %}
                                    <tr>
                                        <td>{{ method.payment_method|title }}</td>
                                        <td class="text-end">{{ method.count }}</td>
                                        <td class="text-end">ETB {{ method.total_amount|floatformat:2 }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Status Distribution</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Status</th>
                                        <th class="text-end">Count</th>
                                        <th class="text-end">Total Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for status in status_distribution %}
                                    <tr>
                                        <td>
                                            <span class="badge 
                                                {% if status.status == 'completed' %}bg-success
                                                {% elif status.status == 'pending' %}bg-warning
                                                {% elif status.status == 'failed' %}bg-danger
                                                {% else %}bg-info{% endif %}">
                                                {{ status.status|title }}
                                            </span>
                                        </td>
                                        <td class="text-end">{{ status.count }}</td>
                                        <td class="text-end">ETB {{ status.total_amount|floatformat:2 }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <a href="{% url 'manage_payments' %}" class="btn btn-primary w-100 mb-2">
                            Manage Payments
                        </a>
                    </div>
                    <div class="col-md-4">
                        <a href="{% url 'download_payment_data' %}" class="btn btn-success w-100 mb-2">
                            Export Payment Data
                        </a>
                    </div>
                    <div class="col-md-4">
                        <a href="{% url 'dashboard' %}" class="btn btn-secondary w-100 mb-2">
                            Back to Dashboard
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>